---
title: 2019第30周
date: 2019-07-22 15:50:18
tags: 前端开发, 周报
thumbnail: /images/thumbnails/weekly30.jpeg
---

### 项目探索

#### Lerna.js
管理多package项目，在一个仓库管理多个npm packages 的一种方案。

### cli 开发常用 npm 包
`slash` 把 windows的反斜杠路径转成unix格式的文件路径格式
`semver` node 版本的语义化版本控制
`minimist` 解析命令行参数
`commander` 为快速开发命令行工具提供模板
`chalk` 颜色显示

### 代码片段
#### NodeJS V10 核心模块， readline
```javascript
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// 询问是否退出
rl.on('SIGINT', () => {
  rl.question('确定要退出吗？', (answer) => {
    if (answer.match(/^y(es)?$/i)) rl.pause();
  });
});

// 问题收集
rl.question('你最喜欢的食物是什么？', (answer) => {
  console.log(`你最喜欢的食物是 ${answer}`);
});

// 清除光标左右或者整行内容
rl.clearLine(stream, dir) // dir 0 | -1 | 1

// 将光标移动到指定位置
rl.cursorTo(stream, x, y)

// 清除光标位置往下的内容
rl..clearScreenDown(stream);

```

```javascript
// 逐行读取文件
const readline = require('readline');
const fs = require('fs');

const rl = readline.createInterface({
  input: fs.createReadStream('sample.txt'),
  crlfDelay: Infinity
});

rl.on('line', (line) => {
  console.log(`文件的每行内容：${line}`);
});
```


#### 小技巧
#### 1. 用gitHooks约束 commit message
之前有用过，这周看 vue-cli 源码发现了又如下的 verify commit message 逻辑，觉得挺实用的，特别适合对项目有追求的强迫症患者或者多人合作的项目约束风格的统一。
```javascript
const chalk = require('chalk')  // eslint-disable-line
const msgPath = process.env.GIT_PARAMS
const msg = require('fs').readFileSync(msgPath, 'utf-8').trim()

const commitRE = /^(v\d+\.\d+\.\d+(-(alpha|beta|rc.\d+))?)|((revert: )?(feat|fix|docs|style|refactor|perf|test|workflow|ci|chore|types)(\(.+\))?!?: .{1,50})/

if (!commitRE.test(msg)) {
  console.log()
  console.error(
    `  ${chalk.bgRed.white(' ERROR ')} ${chalk.red(`invalid commit message format.`)}\n\n` +
    chalk.red(`  Proper commit message format is required for automated changelog generation. Examples:\n\n`) +
    `    ${chalk.green(`feat(compiler): add 'comments' option`)}\n` +
    `    ${chalk.green(`fix(v-model): handle events on blur (close #28)`)}\n\n` +
    chalk.red(`  See .github/COMMIT_CONVENTION.md for more details.\n`) +
    chalk.red(`  You can also use ${chalk.cyan(`npm run commit`)} to interactively generate a commit message.\n`)
  )
  process.exit(1)
}
```
> 脚本的作用是限制 commit 信息必须是 `feat|fix|docs|style|refactor|perf|test|workflow|ci|chore|types`打头，或者版本号开头，看vue-cli的提交记录更直观
![](https://user-images.githubusercontent.com/8393757/61620810-2c56a280-aca4-11e9-94e1-23214ea6e19d.png)

要使上面的逻辑生效，我们还需要安装 [yorkie](https://github.com/yyx990803/yorkie)
```javascript
npm install yorkie --save-dev
```
然后在项目的 package.json 中加入以下配置
```json
{
  "gitHooks": {
    "commit-msg": "node scripts/verifyCommitMessage.js"
  },
}
```

到此我们就配置完成了

配置完成后我们要是不按照约定的格式书写commit message，提交就会被挡住，看下图：

![image-20190722164648837](../images/image-20190722164648837.png)

> 相关原理可以参看 [Git hooks](https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90)，我们引入的第三方库安装后会在仓库的`.git/hooks`目录下为我们设置一些hooks脚本，这些hooks脚本的任务是接管我们的node或shell脚本，使其在正确的时机执行，为我们隐藏了直接自己在./git/hooks路径下编写hook脚本的复杂性

> 你还可以指定在commit前做一些预处理(pre-commit)，比如执行eslint，对git提交做进一步的规范和约束，详细用法请阅读文档。
>
> 类似的工具还有 [husky](https://github.com/typicode/husky)

#### 2. `npm home`
1. 快速打开一个npm项目的首页 `npm home react`
2. 快速打开当前项目的仓库地址  `npm home .`
